<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>מתחבר...</title>
<style>
body{font-family:sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#1E3A8A;color:white;text-align:center;flex-direction:column;gap:16px}
.spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
p{font-size:16px;opacity:.8}
</style>
</head>
<body>
<div class="spinner"></div>
<p>מחבר את חשבון Google...</p>
<script>
var hash = window.location.hash;
var params = new URLSearchParams(hash.substring(1));
var token = params.get('access_token');

if(token){
  // שמור ב-localStorage (fallback לדפדפן רגיל)
  try{
    localStorage.setItem('gtoken', token);
    localStorage.setItem('syen', '1');
    localStorage.setItem('oauth_done', Date.now().toString());
  }catch(e){}

  // שלח postMessage לחלון ההורה (APK — Capacitor WebView)
  try{
    if(window.opener){
      window.opener.postMessage({type:'oauth_token', token:token}, '*');
    }
  }catch(e){}

  // נסה גם דרך parent
  try{
    if(window.parent && window.parent !== window){
      window.parent.postMessage({type:'oauth_token', token:token}, '*');
    }
  }catch(e){}

  document.querySelector('p').textContent = 'מחובר! סוגר...';

  // חזור לאפליקציה אחרי רגע קצר
  setTimeout(function(){
    // נסה לסגור את הדפדפן
    try{ window.close(); }catch(e){}
    // fallback — redirect לדף הראשי
    window.location.href = 'index.html';
  }, 1200);

} else {
  document.querySelector('p').textContent = 'שגיאה בהתחברות. חוזר...';
  setTimeout(function(){
    window.location.href = 'index.html';
  }, 2000);
}
</script>
</body>
</html>
