<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="××¢×§×‘ ×©×¢×•×ª">
<meta name="theme-color" content="#1E3A8A" id="metaTC">
<link rel="manifest" href="manifest.json">
<title>××¢×§×‘ ×©×¢×•×ª Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
:root{
  --b8:#1E3A8A;--b7:#1D4ED8;--b6:#2563EB;--b5:#3B82F6;--b4:#60A5FA;--b1:#DBEAFE;--b0:#EFF6FF;
  --g:#10B981;--gl:#D1FAE5;--r:#EF4444;--rl:#FEE2E2;--am:#F59E0B;--aml:#FEF3C7;
  --bg:#F0F4FF;--s:#fff;--s2:#F8FAFF;--bd:#E2E8F0;--t:#0F172A;--t2:#475569;--t3:#94A3B8;
  --sh:0 1px 4px rgba(30,58,138,.08);--shm:0 4px 20px rgba(30,58,138,.12);--shl:0 10px 40px rgba(30,58,138,.18);
  --r1:18px;--r2:12px;--r3:8px;--nh:68px;--hh:60px;
}
[data-theme=dark]{
  --bg:#080E1E;--s:#111827;--s2:#1E293B;--bd:#1E3A5F;--t:#F1F5F9;--t2:#94A3B8;--t3:#475569;
  --b1:#1E3A5F;--b0:#162036;--gl:#064E3B;--rl:#450A0A;--aml:#451A03;
  --sh:0 1px 4px rgba(0,0,0,.3);--shm:0 4px 20px rgba(0,0,0,.4);--shl:0 10px 40px rgba(0,0,0,.5);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Heebo',sans-serif;background:var(--bg);color:var(--t);min-height:100vh;padding-top:var(--hh);padding-bottom:calc(var(--nh)+12px);transition:background .3s,color .3s;overflow-x:hidden}
.hdr{position:fixed;top:0;left:0;right:0;height:var(--hh);background:var(--b8);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:100;box-shadow:0 2px 20px rgba(30,58,138,.4)}
.hdr-l{display:flex;align-items:center;gap:10px}
.hdr-logo{width:34px;height:34px;background:rgba(255,255,255,.18);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;font-weight:900;color:#fff;flex-shrink:0}
.hdr-title{color:#fff;font-size:16px;font-weight:800;letter-spacing:-.3px;line-height:1.2}
.hdr-sub{color:rgba(255,255,255,.6);font-size:10px;line-height:1.2}
.hdr-r{display:flex;gap:8px}
.ibtn{width:36px;height:36px;border-radius:10px;border:none;background:rgba(255,255,255,.12);color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s;position:relative}
.ibtn:active{background:rgba(255,255,255,.25)}
.sdot{width:8px;height:8px;border-radius:50%;background:var(--g);position:absolute;top:5px;left:5px;border:1.5px solid var(--b8)}
.sdot.off{background:var(--r)}
.bnav{position:fixed;bottom:0;left:0;right:0;height:var(--nh);background:var(--s);border-top:1px solid var(--bd);display:flex;z-index:100;box-shadow:0 -2px 16px rgba(30,58,138,.08);padding-bottom:env(safe-area-inset-bottom)}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;border:none;background:none;cursor:pointer;color:var(--t3);font-family:inherit;transition:color .2s;position:relative;padding:8px 4px}
.ni .nic{font-size:21px;transition:transform .2s}
.ni .nil{font-size:10px;font-weight:700}
.ni.active{color:var(--b8)}
[data-theme=dark] .ni.active{color:var(--b5)}
.ni.active .nic{transform:translateY(-2px)}
.ni::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:0;height:3px;background:var(--b8);border-radius:0 0 4px 4px;transition:width .3s}
[data-theme=dark] .ni::before{background:var(--b5)}
.ni.active::before{width:28px}
.page{display:none;padding:14px;max-width:580px;margin:0 auto;animation:pgIn .25s ease}
.page.active{display:block}
@keyframes pgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--s);border-radius:var(--r1);padding:16px;box-shadow:var(--sh);border:1px solid var(--bd);margin-bottom:12px}
.clk-card{background:linear-gradient(135deg,var(--b8),var(--b6));border-radius:var(--r1);padding:18px;margin-bottom:12px;color:#fff;box-shadow:var(--shl);border:none}
.clk-label{font-size:10px;font-weight:700;opacity:.65;letter-spacing:1.5px;text-transform:uppercase}
.clk-time{font-size:44px;font-weight:900;letter-spacing:-2px;font-variant-numeric:tabular-nums;line-height:1;margin:6px 0 14px}
.clk-time.on{color:#93C5FD}
.btn-clk{width:100%;padding:13px;border-radius:12px;border:none;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.18);color:#fff}
.btn-clk.on{background:rgba(239,68,68,.8)}
.btn-clk:active{transform:scale(.98)}
.qa{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.qab{padding:13px 10px;border-radius:var(--r2);border:1.5px solid var(--bd);background:var(--s);color:var(--t);font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .15s;box-shadow:var(--sh)}
.qab:active{transform:scale(.97);background:var(--b0)}
[data-theme=dark] .qab:active{background:rgba(30,58,138,.3)}
.qab .qi{font-size:18px}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.cal-title{font-size:17px;font-weight:800}
.btn-nav{width:36px;height:36px;border-radius:10px;border:1.5px solid var(--bd);background:var(--s2);color:var(--t2);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.btn-today{padding:9px 14px;border-radius:10px;border:none;background:var(--b8);color:#fff;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer}
.jump-row{display:flex;gap:8px;margin-bottom:12px;align-items:center}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.chc{text-align:center;font-size:10px;font-weight:700;color:var(--t3);padding:5px 0}
.cc{aspect-ratio:1;border-radius:10px;padding:4px 3px;cursor:pointer;display:flex;flex-direction:column;justify-content:space-between;background:var(--s2);border:1.5px solid transparent;transition:all .15s;position:relative;overflow:hidden}
.cc:active{transform:scale(.93)}
.cc.today{border-color:var(--b6);box-shadow:0 0 0 2px var(--b1)}
.cc.has-data{background:var(--b0);border-color:var(--b1)}
[data-theme=dark] .cc.has-data{background:rgba(30,58,138,.25);border-color:var(--b1)}
.cc.missing{background:var(--rl);}
[data-theme=dark] .cc.missing{background:rgba(239,68,68,.1)}
.cc-top{display:flex;justify-content:space-between;align-items:flex-start}
.cc-num{font-size:13px;font-weight:700;line-height:1}
.cc.today .cc-num{color:var(--b6)}
.cc-heb{font-size:8px;color:var(--b6);font-weight:500}
.cc-miss{font-size:9px;position:absolute;top:1px;left:1px}
.cc-bars{display:flex;gap:1px;width:100%;justify-content:center}
.cc-bar{height:3px;border-radius:2px;flex:1;max-width:14px}
.cc-h{font-size:9px;font-weight:800;color:var(--b7);text-align:center}
[data-theme=dark] .cc-h{color:var(--b4)}
.cc-dot{position:absolute;top:2px;right:2px;width:5px;height:5px;border-radius:50%}
.miss-banner{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--aml);border:1px solid var(--am);border-radius:12px;margin-bottom:12px}
[data-theme=dark] .miss-banner{background:rgba(245,158,11,.1)}
.miss-banner-txt{flex:1;font-size:13px}
.miss-banner-txt strong{display:block;font-size:14px;color:var(--am)}
.stats-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.scard{background:var(--s);border-radius:12px;padding:12px 14px;border:1px solid var(--bd);box-shadow:var(--sh)}
.slbl{font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.5px}
.sval{font-size:22px;font-weight:900;margin-top:4px;letter-spacing:-.5px}
.sval.g{color:var(--g)}
.sval.b{color:var(--b7)}
[data-theme=dark] .sval.b{color:var(--b4)}
.csummary{background:var(--b0);border-radius:10px;padding:10px 14px;margin-bottom:10px;font-size:12px;font-weight:600;color:var(--b8);display:flex;gap:14px;flex-wrap:wrap;align-items:center}
[data-theme=dark] .csummary{background:rgba(30,58,138,.3);color:var(--b4)}
.csummary strong{font-size:14px}
.cwrap{position:relative;height:175px;width:100%}
.rtabs{display:flex;gap:6px;background:var(--s2);border-radius:12px;padding:4px;margin-bottom:12px}
.rtab{flex:1;padding:9px 4px;border-radius:9px;border:none;background:transparent;font-family:inherit;font-size:11px;font-weight:700;color:var(--t3);cursor:pointer;transition:all .2s;white-space:nowrap}
.rtab.active{background:var(--s);color:var(--b8);box-shadow:var(--sh)}
[data-theme=dark] .rtab.active{color:var(--b4)}
.pills{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;margin-bottom:12px;scrollbar-width:none}
.pills::-webkit-scrollbar{display:none}
.pill{padding:7px 14px;border-radius:20px;border:1.5px solid var(--bd);background:var(--s2);color:var(--t3);font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .2s}
.pill.active{background:var(--b8);border-color:var(--b8);color:#fff}
.arc-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--bd)}
.arc-row:last-child{border-bottom:none}
.arc-m{font-size:14px;font-weight:700}
.arc-h{font-size:12px;color:var(--t2)}
.arc-p{font-size:15px;font-weight:900;color:var(--g)}
.couple-total{background:linear-gradient(135deg,var(--b8),var(--b6));border-radius:var(--r1);padding:20px;text-align:center;margin-bottom:12px;color:#fff;box-shadow:var(--shl)}
.ct-lbl{font-size:10px;opacity:.7;text-transform:uppercase;letter-spacing:1px;font-weight:700}
.ct-val{font-size:36px;font-weight:900;letter-spacing:-1.5px;margin:6px 0 4px}
.ct-sub{font-size:12px;opacity:.75}
.ucard{border-radius:var(--r1);padding:16px;margin-bottom:10px;border:2px solid}
.uc-top{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.uc-av{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:#fff;flex-shrink:0}
.uc-name{font-size:16px;font-weight:800}
.uc-h{font-size:12px;color:var(--t2)}
.uc-money{font-size:28px;font-weight:900;letter-spacing:-1px}
.pbar{height:6px;border-radius:3px;background:var(--bd);overflow:hidden;margin-top:6px}
.pfill{height:100%;border-radius:3px;transition:width .5s ease}
.pair-box{background:var(--b8);border-radius:var(--r1);padding:20px;text-align:center;margin-bottom:14px;color:#fff}
.pair-lbl{font-size:10px;opacity:.7;letter-spacing:1.5px;text-transform:uppercase;font-weight:700}
.pair-val{font-size:36px;font-weight:900;letter-spacing:8px;margin:8px 0;font-variant-numeric:tabular-nums}
.pair-acts{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.pair-btn{background:rgba(255,255,255,.18);border:none;color:#fff;padding:8px 16px;border-radius:8px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer}
.pair-btn:active{background:rgba(255,255,255,.3)}
.set-sec-ttl{font-size:10px;font-weight:800;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding-right:2px}
.toggle{position:relative;width:46px;height:26px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.tsl{position:absolute;inset:0;background:var(--bd);border-radius:26px;transition:.3s;cursor:pointer}
.tsl:before{content:'';position:absolute;width:20px;height:20px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.toggle input:checked+.tsl{background:var(--b8)}
[data-theme=dark] .toggle input:checked+.tsl{background:var(--b5)}
.toggle input:checked+.tsl:before{transform:translateX(20px)}
.trow{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--bd)}
.trow:last-child{border-bottom:none}
.trow-lbl{font-size:14px;font-weight:600}
.trow-sub{font-size:11px;color:var(--t3);margin-top:2px}
.jcard{border-radius:12px;padding:14px;margin-bottom:10px;background:var(--s2);border:1.5px solid var(--bd);position:relative}
.jcard-top{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.jcbadge{width:14px;height:14px;border-radius:50%;flex-shrink:0}
.jname{flex:1;font-size:14px;font-weight:700;background:transparent;border:none;color:var(--t);font-family:inherit;padding:0;border-bottom:1.5px solid transparent}
.jname:focus{outline:none;border-bottom-color:var(--b6)}
.jnums{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.crow{display:flex;gap:8px;flex-wrap:wrap}
.cdot{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:all .15s;flex-shrink:0}
.cdot.sel{border-color:var(--t);transform:scale(1.15)}
.btn-del-j{position:absolute;top:10px;left:10px;background:none;border:none;color:var(--t3);font-size:16px;cursor:pointer}
.fg{margin-bottom:13px}
.fl{font-size:11px;font-weight:700;color:var(--t2);margin-bottom:5px;display:block;letter-spacing:.3px}
.fi{width:100%;padding:12px 13px;border-radius:var(--r3);border:1.5px solid var(--bd);background:var(--s2);color:var(--t);font-family:inherit;font-size:15px;transition:border-color .2s;-webkit-appearance:none}
.fi:focus{outline:none;border-color:var(--b6);box-shadow:0 0 0 3px var(--b1)}
[data-theme=dark] .fi:focus{box-shadow:0 0 0 3px rgba(37,99,235,.2)}
input[type=time].fi{text-align:center}
.btn{width:100%;padding:13px;border-radius:var(--r2);border:none;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:7px}
.btn:active{transform:scale(.98)}
.btn+.btn{margin-top:8px}
.btn-p{background:var(--b8);color:#fff}
.btn-s{background:var(--g);color:#fff}
.btn-d{background:var(--r);color:#fff}
.btn-o{background:transparent;border:1.5px solid var(--bd);color:var(--t)}
.btn-g{background:var(--b0);color:var(--b8)}
[data-theme=dark] .btn-g{background:rgba(30,58,138,.3);color:var(--b4)}
.btn-sm{padding:9px 13px;font-size:12px;width:auto;border-radius:var(--r3)}
.btn-row{display:flex;gap:10px;margin-top:16px}
.btn-row .btn{flex:1}
.t2row{display:flex;gap:10px}
.t2row>div{flex:1}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px)}
.modal.active{display:flex}
.msh{background:var(--s);border-radius:22px 22px 0 0;width:100%;max-width:580px;max-height:93vh;overflow-y:auto;padding:0 18px calc(20px + env(safe-area-inset-bottom));animation:shUp .3s cubic-bezier(.34,1.56,.64,1)}
@keyframes shUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhdl{width:36px;height:4px;background:var(--bd);border-radius:2px;margin:12px auto 16px}
.mttl{font-size:19px;font-weight:800;margin-bottom:16px}
.msub{font-size:12px;color:var(--t2);margin-top:-10px;margin-bottom:14px}
.mclose{float:left;background:none;border:none;color:var(--t3);font-size:22px;cursor:pointer;line-height:1}
.mnav{display:flex;align-items:center;justify-content:space-between;background:var(--b0);padding:10px 12px;border-radius:10px;margin-bottom:16px}
[data-theme=dark] .mnav{background:rgba(30,58,138,.25)}
.mnav-btn{background:none;border:none;font-size:20px;color:var(--b8);cursor:pointer;padding:0 8px}
[data-theme=dark] .mnav-btn{color:var(--b4)}
.mnav-c{text-align:center}
.mnav-ttl{font-size:15px;font-weight:800;color:var(--b8)}
[data-theme=dark] .mnav-ttl{color:var(--b4)}
.mnav-sub{font-size:10px;color:var(--t3)}
.brow{display:flex;gap:6px;align-items:center;margin-top:8px}
.brow .fi{margin:0}
.bdesc{flex:2}
.bamt{flex:1}
.bdel{background:none;border:none;color:var(--r);font-size:18px;cursor:pointer;padding:4px;flex-shrink:0}
.pdfopt{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--bd);cursor:pointer}
.pdfopt:last-child{border-bottom:none}
.pdfchk{width:22px;height:22px;border-radius:6px;border:2px solid var(--bd);background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;transition:all .15s}
.pdfchk.on{background:var(--b8);border-color:var(--b8);color:#fff}
.pdfopt-lbl{font-size:14px;font-weight:500}
.sf{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:var(--g);color:#fff;border-radius:50%;width:76px;height:76px;display:flex;align-items:center;justify-content:center;font-size:32px;z-index:999;pointer-events:none;transition:all .3s cubic-bezier(.34,1.56,.64,1)}
.sf.show{transform:translate(-50%,-50%) scale(1)}
.sf.bye{transform:translate(-50%,-50%) scale(0);opacity:0}
.ibanner{display:none;background:linear-gradient(135deg,var(--b8),var(--b6));border-radius:var(--r1);padding:16px;margin-bottom:12px;color:#fff}
.ibanner.show{display:block}
.empty{text-align:center;padding:36px 20px;color:var(--t3)}
.empty-ico{font-size:48px;margin-bottom:12px}
.empty-ttl{font-size:16px;font-weight:700;color:var(--t2);margin-bottom:6px}
.empty-sub{font-size:13px;line-height:1.5}
.div{height:1px;background:var(--bd);margin:14px 0}
.pbar-wrap{height:6px;background:var(--bd);border-radius:3px;overflow:hidden;margin-top:6px}
.pbar-fill{height:100%;border-radius:3px;transition:width .5s}
</style>
</head>
<body>

<header class="hdr">
  <div class="hdr-l">
    <div class="hdr-logo">â‚ª</div>
    <div>
      <div class="hdr-title">××¢×§×‘ ×©×¢×•×ª Pro</div>
      <div class="hdr-sub" id="hdrSub">×˜×•×¢×Ÿ...</div>
    </div>
  </div>
  <div class="hdr-r">
    <button class="ibtn" onclick="manualSync()" title="×¡× ×›×¨×Ÿ">â˜ï¸<div class="sdot off" id="sdot"></div></button>
    <button class="ibtn" id="themeBtn" onclick="toggleTheme()">ğŸŒ™</button>
  </div>
</header>

<!-- PAGE: CALENDAR -->
<div class="page active" id="pg-cal">
  <div class="clk-card">
    <div class="clk-label">×©×¢×•×Ÿ × ×•×›×—×•×ª</div>
    <div class="clk-time" id="clkTime">00:00:00</div>
    <button class="btn-clk" id="clkBtn" onclick="handleClock()">â–¶ ×”×ª×—×œ ××©××¨×ª</button>
  </div>
  <div id="missBanner"></div>
  <div class="qa">
    <button class="qab" onclick="openMulti('hours')"><span class="qi">â±ï¸</span>×©×¢×•×ª ×œ×ª×§×•×¤×”</button>
    <button class="qab" onclick="openMulti('profit')"><span class="qi">ğŸ’°</span>×¨×•×•×— ×œ×ª×§×•×¤×”</button>
    <button class="qab" onclick="openMulti('rate')"><span class="qi">ğŸ’¼</span>×ª×¢×¨×™×£ ×œ×ª×§×•×¤×”</button>
    <button class="qab" onclick="openMulti('job')"><span class="qi">ğŸ¢</span>×©× ×” ××§×•× ×¢×‘×•×“×”</button>
  </div>
  <div class="card">
    <div class="cal-nav">
      <button class="btn-nav" onclick="navMonth(-1)">â—€</button>
      <div class="cal-title" id="calTitle"></div>
      <div style="display:flex;gap:6px">
        <button class="btn-today" onclick="goToday()">×”×™×•×</button>
        <button class="btn-nav" onclick="navMonth(1)">â–¶</button>
      </div>
    </div>
    <div class="jump-row">
      <input type="date" class="fi" id="jDate" style="flex:1;margin:0">
      <button class="btn btn-g btn-sm" onclick="jumpDate()">×§×¤×•×¥</button>
    </div>
    <div class="cal-grid" id="calGrid"></div>
    <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
      <span style="font-size:10px;color:var(--t3);display:flex;align-items:center;gap:4px"><span style="width:9px;height:9px;background:var(--b0);border:1.5px solid var(--b6);border-radius:3px;display:inline-block"></span>×”×™×•×</span>
      <span style="font-size:10px;color:var(--t3);display:flex;align-items:center;gap:4px"><span style="width:9px;height:9px;background:var(--b0);border-radius:3px;display:inline-block"></span>×™×© × ×ª×•× ×™×</span>
      <span style="font-size:10px;color:var(--t3);display:flex;align-items:center;gap:4px"><span style="width:9px;height:9px;background:var(--rl);border-radius:3px;display:inline-block"></span>×—×¡×¨ âš ï¸</span>
    </div>
  </div>
</div>

<!-- PAGE: REPORTS -->
<div class="page" id="pg-rep">
  <div class="rtabs">
    <button class="rtab active" onclick="switchRTab('gen',this)">ğŸ“Š ×›×œ×œ×™</button>
    <button class="rtab" onclick="switchRTab('jobs',this)">ğŸ’¼ ×œ×¤×™ ×¢×‘×•×“×”</button>
    <button class="rtab" onclick="switchRTab('cmp',this)">ğŸ“ˆ ×”×©×•×•××”</button>
    <button class="rtab" onclick="switchRTab('arc',this)">ğŸ“… ××¨×›×™×•×Ÿ</button>
  </div>
  <div class="pills">
    <button class="pill active" data-p="7" onclick="selPer(this)">7 ×™××™×</button>
    <button class="pill" data-p="14" onclick="selPer(this)">14 ×™××™×</button>
    <button class="pill" data-p="month" onclick="selPer(this)">×”×—×•×“×©</button>
    <button class="pill" data-p="lastMonth" onclick="selPer(this)">×—×•×“×© ×§×•×“×</button>
    <button class="pill" data-p="custom" onclick="selPer(this)">××•×ª××</button>
  </div>
  <div id="custPRow" style="display:none" class="card">
    <div style="display:flex;gap:10px;align-items:flex-end">
      <div style="flex:1"><label class="fl">××ª××¨×™×š</label><input type="date" class="fi" id="rS"></div>
      <div style="flex:1"><label class="fl">×¢×“ ×ª××¨×™×š</label><input type="date" class="fi" id="rE"></div>
      <button class="btn btn-p btn-sm" onclick="updRep()">×¨×¢× ×Ÿ</button>
    </div>
  </div>
  <div id="repContent"></div>
</div>

<!-- PAGE: COUPLE -->
<div class="page" id="pg-couple">
  <div id="coupleContent"></div>
</div>

<!-- PAGE: SETTINGS -->
<div class="page" id="pg-set">
  <div id="instBanner" class="ibanner">
    <div style="font-size:15px;font-weight:800;margin-bottom:4px">ğŸ“± ×”×ª×§×Ÿ ××ª ×”××¤×œ×™×§×¦×™×”</div>
    <div style="font-size:12px;opacity:.8;margin-bottom:12px">×’×™×©×” ××”×™×¨×” ×œ×œ× ×“×¤×“×¤×Ÿ</div>
    <button class="btn btn-o" id="instBtn" style="background:rgba(255,255,255,.15);color:#fff;border-color:rgba(255,255,255,.3)">â¬‡ï¸ ×”×ª×§×Ÿ ×¢×›×©×™×•</button>
  </div>
  <div class="set-sec-ttl" style="margin-top:4px">ğŸ’¼ ××§×•××•×ª ×¢×‘×•×“×” (×¢×“ 3)</div>
  <div id="jobsCont"></div>
  <button class="btn btn-g btn-sm" onclick="addJob()" id="addJobBtn" style="margin-bottom:16px">+ ×”×•×¡×£ ××§×•× ×¢×‘×•×“×”</button>
  <div class="set-sec-ttl">âš™ï¸ ×”×’×“×¨×•×ª ×—×™×©×•×‘</div>
  <div class="card">
    <div class="trow"><div><div class="trow-lbl">×©×¢×•×ª × ×•×¡×¤×•×ª</div><div class="trow-sub">××¢×œ 8 ×©' = 125%, ××¢×œ 10 = 150%</div></div><label class="toggle"><input type="checkbox" id="togOT" onchange="setSetting('calcOvertime',this.checked)"><span class="tsl"></span></label></div>
    <div class="trow"><div><div class="trow-lbl">×¡×™××•×Ÿ ×™××™× ×—×¡×¨×™× âš ï¸</div><div class="trow-sub">×™××™ ×—×•×œ ×œ×œ× ×¨×™×©×•×</div></div><label class="toggle"><input type="checkbox" id="togMiss" onchange="setSetting('showMissing',this.checked)"><span class="tsl"></span></label></div>
  </div>
  <div class="set-sec-ttl">â˜ï¸ ×’×™×‘×•×™ Google Drive (××•×¤×¦×™×•× ×œ×™)</div>
  <div class="card">
    <div id="drOff"><button class="btn btn-o" id="authBtn">ğŸ”— ×—×‘×¨ ×—×©×‘×•×Ÿ Google ×œ×’×™×‘×•×™</button></div>
    <div id="drOn" style="display:none">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px"><span style="font-size:22px">âœ…</span><div><div style="font-size:14px;font-weight:700;color:var(--g)">××—×•×‘×¨ ×•××¡×•× ×›×¨×Ÿ</div><div id="drEmail" style="font-size:11px;color:var(--t2)"></div></div></div>
      <button class="btn btn-g" onclick="manualSync()">ğŸ”„ ×¡× ×›×¨×Ÿ ×¢×›×©×™×•</button>
      <button class="btn btn-o" onclick="disconnDrive()" style="margin-top:8px;color:var(--r);border-color:var(--r)">ğŸ”“ × ×ª×§ ×—×©×‘×•×Ÿ</button>
    </div>
  </div>
  <div class="set-sec-ttl">ğŸ’¾ ×’×™×‘×•×™ ×•×™×™×¦×•×</div>
  <div class="card">
    <button class="btn btn-o" onclick="expCSV()">ğŸ“Š ×™×™×¦×•× CSV</button>
    <button class="btn btn-o" onclick="expJSON()" style="margin-top:8px">ğŸ“¦ ×™×™×¦×•× JSON (×’×™×‘×•×™ ××œ×)</button>
    <button class="btn btn-g" onclick="openM('mPDF')" style="margin-top:8px">ğŸ“„ ×™×™×¦×•× PDF ××•×ª××</button>
    <div class="div"></div>
    <label class="btn btn-o" style="cursor:pointer">ğŸ“‚ ×©×—×–×•×¨ ×-JSON<input type="file" accept=".json" onchange="restoreData(event)" style="display:none"></label>
    <button class="btn btn-d" onclick="openM('mDel')" style="margin-top:8px">ğŸ—‘ï¸ ××—×™×§×ª × ×ª×•× ×™×</button>
  </div>
</div>

<nav class="bnav">
  <button class="ni active" onclick="swPage('cal',this)"><span class="nic">ğŸ“…</span><span class="nil">×™×•××Ÿ</span></button>
  <button class="ni" onclick="swPage('rep',this)"><span class="nic">ğŸ“ˆ</span><span class="nil">×“×•×—×•×ª</span></button>
  <button class="ni" onclick="swPage('couple',this)"><span class="nic">ğŸ‘«</span><span class="nil">×‘×™×—×“</span></button>
  <button class="ni" onclick="swPage('set',this)"><span class="nic">âš™ï¸</span><span class="nil">×”×’×“×¨×•×ª</span></button>
</nav>
<div class="sf" id="sf">âœ“</div>

<!-- MODAL: DAILY -->
<div class="modal" id="mDay">
  <div class="msh">
    <div class="mhdl"></div>
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div><div class="mttl" id="mDayTtl"></div><div class="msub" id="mDaySub"></div></div>
      <button class="mclose" onclick="closeM('mDay')">âœ•</button>
    </div>
    <div class="mnav">
      <button class="mnav-btn" onclick="navDay(-1)">â—€</button>
      <div class="mnav-c"><div class="mnav-ttl" id="mNavTtl"></div><div class="mnav-sub" id="mNavSub"></div></div>
      <button class="mnav-btn" onclick="navDay(1)">â–¶</button>
    </div>
    <div class="fg"><label class="fl">××§×•× ×¢×‘×•×“×”</label><select class="fi" id="dJob" onchange="onJobCh()"></select></div>
    <div class="t2row">
      <div class="fg"><label class="fl">×›× ×™×¡×”</label><input type="time" class="fi" id="dS" onchange="calcT()"></div>
      <div class="fg"><label class="fl">×™×¦×™××”</label><input type="time" class="fi" id="dE" onchange="calcT()"></div>
    </div>
    <div class="fg">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
        <label class="fl" style="margin:0">×¡×”"×› ×©×¢×•×ª</label>
        <button class="btn btn-g btn-sm" onclick="copyYest()" style="padding:5px 10px;font-size:11px">ğŸ” ×××ª××•×œ</button>
      </div>
      <input type="number" class="fi" id="dH" step="0.25" placeholder="0.00">
    </div>
    <div class="fg"><label class="fl">×ª×¢×¨×™×£ ×©×¢×ª×™ (â‚ª)</label><input type="number" class="fi" id="dR" placeholder="0"></div>
    <div id="dBonCont" style="margin-bottom:13px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span class="fl" style="margin:0">×ª×•×¡×¤×•×ª ×•×‘×•× ×•×¡×™×</span>
        <button class="btn btn-g btn-sm" onclick="addB()" style="padding:5px 10px;font-size:11px">+ ×”×•×¡×£</button>
      </div>
      <div id="dBonList"></div>
    </div>
    <div class="fg"><label class="fl">×”×¢×¨×”</label><input type="text" class="fi" id="dNote" placeholder="×”×¢×¨×” ××•×¤×¦×™×•× ×œ×™×ª..."></div>
    <div class="btn-row">
      <button class="btn btn-p" onclick="saveDay()">ğŸ’¾ ×©××•×¨</button>
      <button class="btn btn-o" onclick="closeM('mDay')">×‘×™×˜×•×œ</button>
    </div>
    <div style="height:8px"></div>
  </div>
</div>

<!-- MODAL: MULTI -->
<div class="modal" id="mMulti">
  <div class="msh">
    <div class="mhdl"></div>
    <div class="mttl" id="mMTtl"></div>
    <div id="mMBody"></div>
    <div class="fg"><label class="fl">×¢×œ ××™×œ×• ×ª××¨×™×›×™×?</label>
      <select class="fi" id="mRng" onchange="document.getElementById('mCR').style.display=this.value==='custom'?'block':'none'">
        <option value="today">×¨×§ ×”×™×•×</option><option value="week">×”×©×‘×•×¢</option>
        <option value="month">×”×—×•×“×©</option><option value="lastMonth">×—×•×“×© ×§×•×“×</option>
        <option value="custom">×˜×•×•×— ××•×ª××...</option>
      </select>
    </div>
    <div id="mCR" style="display:none"><div style="display:flex;gap:10px">
      <div style="flex:1"><label class="fl">×</label><input type="date" class="fi" id="mCS"></div>
      <div style="flex:1"><label class="fl">×¢×“</label><input type="date" class="fi" id="mCE"></div>
    </div></div>
    <div class="btn-row">
      <button class="btn btn-p" onclick="execMulti()">×‘×¦×¢</button>
      <button class="btn btn-o" onclick="closeM('mMulti')">×‘×™×˜×•×œ</button>
    </div>
    <div style="height:8px"></div>
  </div>
</div>

<!-- MODAL: PDF -->
<div class="modal" id="mPDF">
  <div class="msh">
    <div class="mhdl"></div>
    <div style="display:flex;justify-content:space-between;align-items:center"><div class="mttl">ğŸ“„ ×™×™×¦×•× PDF</div><button class="mclose" onclick="closeM('mPDF')">âœ•</button></div>
    <div class="fg"><label class="fl">×ª×§×•×¤×”</label>
      <select class="fi" id="pdfPer" onchange="document.getElementById('pdfCR').style.display=this.value==='custom'?'block':'none'">
        <option value="week">×”×©×‘×•×¢</option><option value="month" selected>×”×—×•×“×©</option>
        <option value="lastMonth">×—×•×“×© ×§×•×“×</option><option value="custom">×˜×•×•×— ××•×ª××...</option>
      </select>
    </div>
    <div id="pdfCR" style="display:none;margin-bottom:12px"><div style="display:flex;gap:10px">
      <div style="flex:1"><label class="fl">×</label><input type="date" class="fi" id="pdfS"></div>
      <div style="flex:1"><label class="fl">×¢×“</label><input type="date" class="fi" id="pdfE"></div>
    </div></div>
    <div class="fg"><label class="fl">×©× ×œ×“×•×— (××•×¤×¦×™×•× ×œ×™)</label><input type="text" class="fi" id="pdfNm" placeholder="×©××™"></div>
    <div class="card" style="padding:14px;margin-bottom:12px">
      <div class="fl" style="margin-bottom:8px">××” ×œ×›×œ×•×œ?</div>
      <div class="pdfopt" onclick="tpdf('po1')"><div class="pdfchk on" id="po1">âœ“</div><span class="pdfopt-lbl">×©×¢×•×ª ×¢×‘×•×“×”</span></div>
      <div class="pdfopt" onclick="tpdf('po2')"><div class="pdfchk on" id="po2">âœ“</div><span class="pdfopt-lbl">×ª×¢×¨×™×£ ×©×¢×ª×™</span></div>
      <div class="pdfopt" onclick="tpdf('po3')"><div class="pdfchk on" id="po3">âœ“</div><span class="pdfopt-lbl">×‘×•× ×•×¡×™× ×•×ª×•×¡×¤×•×ª</span></div>
      <div class="pdfopt" onclick="tpdf('po4')"><div class="pdfchk" id="po4"></div><span class="pdfopt-lbl">×”×¢×¨×•×ª</span></div>
      <div class="pdfopt" onclick="tpdf('po5')"><div class="pdfchk" id="po5"></div><span class="pdfopt-lbl">× ×ª×•× ×™ ×¤×¨×˜× ×¨ (×× ××—×•×‘×¨)</span></div>
    </div>
    <button class="btn btn-p" onclick="genPDF()">ğŸ“¥ ×¦×•×¨ PDF</button>
    <div style="height:8px"></div>
  </div>
</div>

<!-- MODAL: PAIR -->
<div class="modal" id="mPair">
  <div class="msh">
    <div class="mhdl"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div class="mttl" style="margin:0">ğŸ‘« ×—×™×‘×•×¨ ×–×•×’×™</div>
      <button class="mclose" onclick="closeM('mPair')">âœ•</button>
    </div>
    <div id="pairCont"></div>
    <div style="height:8px"></div>
  </div>
</div>

<!-- MODAL: DELETE -->
<div class="modal" id="mDel">
  <div class="msh">
    <div class="mhdl"></div>
    <div class="mttl">ğŸ—‘ï¸ ××—×™×§×ª × ×ª×•× ×™×</div>
    <div class="fg"><label class="fl">××” ×œ××—×•×§?</label>
      <select class="fi" id="delR" onchange="document.getElementById('delCR').style.display=this.value==='custom'?'block':'none'">
        <option value="week">×”×©×‘×•×¢</option><option value="month">×”×—×•×“×©</option>
        <option value="lastMonth">×—×•×“×© ×§×•×“×</option><option value="custom">×˜×•×•×— ××•×ª××...</option>
        <option value="all">×›×œ ×”× ×ª×•× ×™×!</option>
      </select>
    </div>
    <div id="delCR" style="display:none;margin-bottom:12px"><div style="display:flex;gap:10px">
      <div style="flex:1"><label class="fl">×</label><input type="date" class="fi" id="delS"></div>
      <div style="flex:1"><label class="fl">×¢×“</label><input type="date" class="fi" id="delE"></div>
    </div></div>
    <button class="btn btn-d" onclick="execDel()">××—×§ ×œ×¦××™×ª×•×ª</button>
    <button class="btn btn-o" onclick="closeM('mDel')" style="margin-top:8px">×‘×™×˜×•×œ</button>
    <div style="height:8px"></div>
  </div>
</div>

<script>
// ---- CONSTANTS ----
const JC=['#1E3A8A','#2563EB','#10B981','#F59E0B','#EF4444','#8B5CF6'];
const MN=['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
const CID='57616527068-9ogg9tnmgcku8icu5bjkvd7e48b9hujs.apps.googleusercontent.com';
const SCOPES='https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.email';
let curDt=new Date(), selDt=null, mType='', per='7', rTab='gen';
let hCh,pCh,cmpCh,cplCh,jCh;
let aToken=null, tClient=null, dProm=null, tInt=null;

// ---- STORAGE ----
const DEF_S={jobs:[{name:'×¢×‘×•×“×” ×¨××©×™×ª',color:'#1E3A8A',rate:50,fixed:0}],calcOvertime:false,showMissing:true,myName:'×× ×™',myColor:'#1E3A8A',partnerName:'×¤×¨×˜× ×¨',partnerColor:'#10B981',pairCode:null,partnerCode:null,myUID:null,theme:'light'};
const D={
  g:()=>{try{return JSON.parse(localStorage.getItem('wd')||'{}');}catch{return {};}},
  s:d=>{localStorage.setItem('wd',JSON.stringify(d));localStorage.setItem('wdts',Date.now());},
  gs:()=>{try{return Object.assign({},DEF_S,JSON.parse(localStorage.getItem('settings')||'{}'));}catch{return {...DEF_S};}},
  ss:s=>localStorage.setItem('settings',JSON.stringify(s)),
  gp:()=>{try{return JSON.parse(localStorage.getItem('pd')||'{}');}catch{return {};}},
  sp:d=>localStorage.setItem('pd',JSON.stringify(d))
};
const fk=d=>{const dt=d instanceof Date?d:new Date(d);return`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;};

// ---- HEBREW CAL ----
const HC=(()=>{
  const g=n=>{const o=['','×','×‘','×’','×“','×”','×•','×–','×—','×˜'],t=['','×™','×›','×œ','×','× ','×¡','×¢','×¤','×¦'];if(n===15)return'×˜×´×•';if(n===16)return'×˜×´×–';let r=(t[Math.floor((n%100)/10)]||'')+(o[n%10]||'');return r.length>1?r.slice(0,-1)+'×´'+r.slice(-1):r+'×³';};
  return{f:d=>{try{const f=new Intl.DateTimeFormat('he-IL-u-ca-hebrew',{day:'numeric',month:'short'});let dy='',mo='';for(const p of f.formatToParts(d)){if(p.type==='day'){const n=parseInt(p.value);dy=isNaN(n)?p.value:g(n);}if(p.type==='month')mo=p.value;}return dy+' '+mo;}catch{return '';}}};
})();

// ---- PROFIT ----
function cp(h,r,b=[]){
  const s=D.gs();
  let base=s.calcOvertime&&h>8?(8*r)+(Math.min(h-8,2)*r*1.25)+(Math.max(h-10,0)*r*1.5):h*r;
  const bon=(b||[]).reduce((a,x)=>a+(parseFloat(x.amount)||0),0);
  return{base,bonus:bon,total:base+bon};
}

// ---- DATES ----
function getDts(r,sId,eId){
  const t=new Date();let st=new Date(t),en=new Date(t);
  if(r==='week'){st.setDate(t.getDate()-t.getDay());en.setDate(st.getDate()+6);}
  else if(r==='month'){st=new Date(t.getFullYear(),t.getMonth(),1);en=new Date(t.getFullYear(),t.getMonth()+1,0);}
  else if(r==='lastMonth'){st=new Date(t.getFullYear(),t.getMonth()-1,1);en=new Date(t.getFullYear(),t.getMonth(),0);}
  else if(r==='custom'){const sv=document.getElementById(sId)?.value,ev=document.getElementById(eId)?.value;if(!sv||!ev)return[];st=new Date(sv);en=new Date(ev);}
  const res=[];for(let d=new Date(st);d<=en;d.setDate(d.getDate()+1))res.push(new Date(d));return res;
}
function getPerDts(p){
  if(p==='7'||p==='14'){const n=parseInt(p);return[...Array(n).keys()].map(i=>{const d=new Date();d.setDate(d.getDate()-n+1+i);return d;});}
  return getDts(p,'rS','rE');
}

// ---- THEME ----
function toggleTheme(silent=false){
  const dk=document.body.getAttribute('data-theme')==='dark';
  const th=dk?'light':'dark';
  document.body.setAttribute('data-theme',th);
  document.getElementById('themeBtn').textContent=th==='dark'?'â˜€ï¸':'ğŸŒ™';
  document.getElementById('metaTC').content=th==='dark'?'#080E1E':'#1E3A8A';
  if(!silent){const s=D.gs();s.theme=th;D.ss(s);}
  vib();
}

// ---- PAGES ----
function swPage(p,btn){
  vib();
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(x=>x.classList.remove('active'));
  document.getElementById('pg-'+p).classList.add('active');
  btn.classList.add('active');
  if(p==='rep')updRep();
  if(p==='couple')renderCouple();
  if(p==='set')renderSettings();
}

// ---- CALENDAR ----
function renderCal(){
  const y=curDt.getFullYear(),m=curDt.getMonth();
  document.getElementById('calTitle').textContent=`${MN[m]} ${y}`;
  const grid=document.getElementById('calGrid');grid.innerHTML='';
  const data=D.g(),pd=D.gp(),s=D.gs(),tk=fk(new Date()),today=new Date();today.setHours(0,0,0,0);
  ['×','×‘','×’','×“','×”','×•','×©'].forEach(d=>{const h=document.createElement('div');h.className='chc';h.textContent=d+"'";grid.appendChild(h);});
  const first=new Date(y,m,1).getDay();
  for(let i=0;i<first;i++)grid.appendChild(document.createElement('div'));
  const days=new Date(y,m+1,0).getDate();let miss=0;
  for(let d=1;d<=days;d++){
    const dt=new Date(y,m,d),k=fk(dt);
    const hasMe=(data[k]?.hours||0)>0,hasPrt=(pd[k]?.hours||0)>0;
    const isT=k===tk,isPast=dt<today&&!isT,isWd=dt.getDay()!==6;
    const isMiss=s.showMissing&&isPast&&isWd&&!hasMe;
    if(isMiss)miss++;
    const c=document.createElement('div');
    c.className='cc'+(isT?' today':isMiss?' missing':hasMe?' has-data':'');
    c.onclick=()=>{vib();openDay(k);};
    let html='';
    if(data[k]?.note||(data[k]?.bonuses?.length>0)){const col=s.jobs?.[data[k]?.jobIdx||0]?.color||'#1E3A8A';html+=`<div class="cc-dot" style="background:${col}"></div>`;}
    if(isMiss)html+=`<div class="cc-miss">âš ï¸</div>`;
    html+=`<div class="cc-top"><div class="cc-num">${d}</div></div><div class="cc-heb">${HC.f(dt)}</div>`;
    const bars=[];
    if(hasMe){const col=s.jobs?.[data[k]?.jobIdx||0]?.color||'#1E3A8A';bars.push(`<div class="cc-bar" style="background:${col}"></div>`);}
    if(hasPrt)bars.push(`<div class="cc-bar" style="background:${s.partnerColor}"></div>`);
    if(bars.length)html+=`<div class="cc-bars">${bars.join('')}</div>`;
    else if(hasMe)html+=`<div class="cc-h">${data[k].hours}×©'</div>`;
    c.innerHTML=html;grid.appendChild(c);
  }
  const mb=document.getElementById('missBanner');
  if(miss>0&&D.gs().showMissing){mb.innerHTML=`<div class="miss-banner"><span style="font-size:20px">âš ï¸</span><div class="miss-banner-txt"><strong>${miss} ×™××™× ×œ×œ× ×¨×™×©×•×</strong>×œ×—×¥ ×¢×œ ×™×•× ××¡×•××Ÿ ×œ×ª×™×§×•×Ÿ</div></div>`;}
  else{mb.innerHTML='';}
  updHdrSub();
}
function navMonth(d){vib();curDt.setMonth(curDt.getMonth()+d);renderCal();}
function goToday(){vib();curDt=new Date();renderCal();}
function jumpDate(){const v=document.getElementById('jDate').value;if(v){curDt=new Date(v);renderCal();}}
function updHdrSub(){
  const data=D.g(),s=D.gs(),now=new Date(),mk=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  let h=0,p=0;
  Object.keys(data).forEach(k=>{if(k.startsWith(mk)){h+=data[k].hours||0;p+=cp(data[k].hours,data[k].rate,data[k].bonuses).total;}});
  (s.jobs||[]).forEach(j=>p+=parseFloat(j.fixed)||0);
  document.getElementById('hdrSub').textContent=`×”×—×•×“×©: ${h.toFixed(1)} ×©' | â‚ª${Math.round(p).toLocaleString('he-IL')}`;
}

// ---- DAY MODAL ----
function openDay(k){
  selDt=new Date(k);const data=D.g(),s=D.gs();
  const d=data[k]||{hours:'',rate:s.jobs?.[0]?.rate||50,note:'',bonuses:[],jobIdx:0,startTime:'',endTime:''};
  document.getElementById('mDayTtl').textContent=k;
  document.getElementById('mDaySub').textContent=HC.f(selDt);
  document.getElementById('mNavTtl').textContent=k;
  document.getElementById('mNavSub').textContent=HC.f(selDt);
  const jsel=document.getElementById('dJob');
  jsel.innerHTML=(s.jobs||[]).map((j,i)=>`<option value="${i}"${i===(d.jobIdx||0)?' selected':''}>${j.name}</option>`).join('');
  document.getElementById('dH').value=d.hours||'';
  document.getElementById('dR').value=d.rate||'';
  document.getElementById('dS').value=d.startTime||'';
  document.getElementById('dE').value=d.endTime||'';
  document.getElementById('dNote').value=d.note||'';
  document.getElementById('dBonList').innerHTML='';
  (d.bonuses||[]).forEach(b=>addB(b.desc,b.amount));
  openM('mDay');
}
function onJobCh(){const s=D.gs(),ji=parseInt(document.getElementById('dJob').value);const j=s.jobs?.[ji];if(j)document.getElementById('dR').value=j.rate||'';}
function calcT(){const sv=document.getElementById('dS').value,ev=document.getElementById('dE').value;if(sv&&ev){const[sh,sm]=sv.split(':').map(Number),[eh,em]=ev.split(':').map(Number);let df=(eh+em/60)-(sh+sm/60);if(df<0)df+=24;document.getElementById('dH').value=df.toFixed(2);}}
function copyYest(){const y=new Date(selDt);y.setDate(y.getDate()-1);const d=D.g()[fk(y)];if(d)document.getElementById('dH').value=d.hours;}
function addB(desc='',amt=''){const list=document.getElementById('dBonList');const row=document.createElement('div');row.className='brow';row.innerHTML=`<input type="text" class="fi bdesc" placeholder="×¡×™×‘×”" value="${desc}"><input type="number" class="fi bamt" placeholder="â‚ª" value="${amt}"><button class="bdel" onclick="this.parentElement.remove()">Ã—</button>`;list.appendChild(row);}
function saveDay(){
  const data=D.g(),bons=[];
  document.querySelectorAll('#dBonList .brow').forEach(r=>{const desc=r.querySelector('.bdesc').value,amt=parseFloat(r.querySelector('.bamt').value);if(amt>0)bons.push({desc:desc||'×ª×•×¡×¤×ª',amount:amt});});
  const k=fk(selDt);
  data[k]={hours:parseFloat(document.getElementById('dH').value)||0,rate:parseFloat(document.getElementById('dR').value)||0,note:document.getElementById('dNote').value,bonuses:bons,jobIdx:parseInt(document.getElementById('dJob').value)||0,startTime:document.getElementById('dS').value,endTime:document.getElementById('dE').value};
  D.s(data);closeM('mDay');renderCal();updRep();saveDr();flash();vib();
}
function navDay(delta){const d=new Date(selDt);d.setDate(d.getDate()+delta);closeM('mDay');openDay(fk(d));}

// ---- MULTI MODAL ----
function openMulti(type){
  mType=type;const s=D.gs();const body=document.getElementById('mMBody');
  if(type==='hours'){document.getElementById('mMTtl').textContent='â±ï¸ ×”×—×œ×ª ×©×¢×•×ª ×§×‘×•×¢×•×ª';body.innerHTML=`<div class="fg"><label class="fl">××¡×¤×¨ ×©×¢×•×ª</label><input type="number" class="fi" id="mV" step="0.25" placeholder="8"></div>`;}
  else if(type==='profit'){document.getElementById('mMTtl').textContent='ğŸ’° ×”×•×¡×¤×ª ×¨×•×•×— ×§×‘×•×¢';body.innerHTML=`<div class="fg"><label class="fl">×¡×›×•× (â‚ª)</label><input type="number" class="fi" id="mV"></div><div class="fg"><label class="fl">×ª×™××•×¨</label><input type="text" class="fi" id="mVD" placeholder="×‘×•× ×•×¡, × ×¡×™×¢×•×ª..."></div>`;}
  else if(type==='rate'){document.getElementById('mMTtl').textContent='ğŸ’¼ ×©×™× ×•×™ ×ª×¢×¨×™×£';body.innerHTML=`<div class="fg"><label class="fl">×ª×¢×¨×™×£ ×©×¢×ª×™ (â‚ª)</label><input type="number" class="fi" id="mV"></div>`;}
  else if(type==='job'){document.getElementById('mMTtl').textContent='ğŸ¢ ×©× ×” ××§×•× ×¢×‘×•×“×”';body.innerHTML=`<div class="fg"><label class="fl">××§×•× ×¢×‘×•×“×”</label><select class="fi" id="mV">${(s.jobs||[]).map((j,i)=>`<option value="${i}">${j.name}</option>`).join('')}</select></div>`;}
  openM('mMulti');
}
function execMulti(){
  const val=document.getElementById('mV')?.value;if(val===''||val===null||val===undefined)return;
  const dates=getDts(document.getElementById('mRng').value,'mCS','mCE');if(!dates.length)return;
  const data=D.g(),s=D.gs();
  dates.forEach(d=>{const k=fk(d);if(!data[k])data[k]={hours:0,rate:s.jobs?.[0]?.rate||50,bonuses:[],note:'',jobIdx:0};
    if(mType==='hours')data[k].hours=parseFloat(val)||0;
    else if(mType==='rate')data[k].rate=parseFloat(val)||0;
    else if(mType==='job')data[k].jobIdx=parseInt(val)||0;
    else if(mType==='profit'){if(!data[k].bonuses)data[k].bonuses=[];data[k].bonuses.push({desc:document.getElementById('mVD')?.value||'×ª×•×¡×¤×ª',amount:parseFloat(val)||0});}
  });
  D.s(data);closeM('mMulti');renderCal();updRep();saveDr();flash();vib();
}

// ---- REPORTS ----
function selPer(btn){vib();document.querySelectorAll('.pill').forEach(b=>b.classList.remove('active'));btn.classList.add('active');per=btn.dataset.p;document.getElementById('custPRow').style.display=per==='custom'?'block':'none';if(per!=='custom')updRep();}
function switchRTab(tab,btn){vib();document.querySelectorAll('.rtab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');rTab=tab;updRep();}
function updRep(){
  if(!document.getElementById('pg-rep').classList.contains('active'))return;
  const dates=getPerDts(per);if(!dates.length)return;
  const cont=document.getElementById('repContent');
  if(rTab==='gen')renderGen(dates,cont);
  else if(rTab==='jobs')renderJobs(dates,cont);
  else if(rTab==='cmp')renderCmp(cont);
  else if(rTab==='arc')renderArc(cont);
}

const cOpts=dk=>({responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:dk?'rgba(255,255,255,0.05)':'rgba(0,0,0,0.05)'},ticks:{color:dk?'#475569':'#94A3B8',font:{size:10,family:'Heebo'},maxRotation:0}},y:{grid:{color:dk?'rgba(255,255,255,0.05)':'rgba(0,0,0,0.05)'},ticks:{color:dk?'#475569':'#94A3B8',font:{size:10,family:'Heebo'}}}}});

function renderGen(dates,cont){
  const data=D.g();let th=0,tp=0;const lb=[],hd=[],pd2=[];
  dates.forEach(d=>{const k=fk(d);lb.push(`${d.getDate()}/${d.getMonth()+1}`);if(data[k]){const pr=cp(data[k].hours,data[k].rate,data[k].bonuses);th+=data[k].hours;tp+=pr.total;hd.push(data[k].hours);pd2.push(pr.total);}else{hd.push(0);pd2.push(0);}});
  const aH=dates.length?th/dates.length:0,aP=dates.length?tp/dates.length:0;
  const dk=document.body.getAttribute('data-theme')==='dark';
  cont.innerHTML=`
  <div class="stats-row">
    <div class="scard"><div class="slbl">×¡×”"×› ×©×¢×•×ª</div><div class="sval b">${th.toFixed(1)}</div></div>
    <div class="scard"><div class="slbl">×¡×”"×› ×”×›× ×¡×”</div><div class="sval g">â‚ª${Math.round(tp).toLocaleString('he-IL')}</div></div>
  </div>
  <div class="card">
    <div class="csummary"><span>×¡×”"×›: <strong>${th.toFixed(1)} ×©'</strong></span><span>×××•×¦×¢: <strong>${aH.toFixed(1)} ×©'/×™×•×</strong></span></div>
    <div class="cwrap"><canvas id="hCh"></canvas></div>
  </div>
  <div class="card">
    <div class="csummary"><span>×¡×”"×›: <strong>â‚ª${Math.round(tp).toLocaleString('he-IL')}</strong></span><span>×××•×¦×¢: <strong>â‚ª${Math.round(aP).toLocaleString('he-IL')}/×™×•×</strong></span></div>
    <div class="cwrap"><canvas id="pCh"></canvas></div>
  </div>`;
  if(hCh)hCh.destroy();hCh=new Chart(document.getElementById('hCh'),{type:'bar',data:{labels:lb,datasets:[{data:hd,backgroundColor:'#2563EB',borderRadius:6,borderSkipped:false}]},options:cOpts(dk)});
  if(pCh)pCh.destroy();pCh=new Chart(document.getElementById('pCh'),{type:'line',data:{labels:lb,datasets:[{data:pd2,borderColor:'#10B981',backgroundColor:'rgba(16,185,129,.1)',fill:true,tension:0.4,pointRadius:3,pointBackgroundColor:'#10B981'}]},options:cOpts(dk)});
}

function renderJobs(dates,cont){
  const data=D.g(),s=D.gs(),jobs=s.jobs||[];
  const st=jobs.map(()=>({h:0,p:0}));let total=0;
  dates.forEach(d=>{const k=fk(d);if((data[k]?.hours||0)>0){const ji=data[k].jobIdx??0;if(st[ji]){const pr=cp(data[k].hours,data[k].rate,data[k].bonuses);st[ji].h+=data[k].hours;st[ji].p+=pr.total;total+=pr.total;}}});
  jobs.forEach((j,i)=>{const f=parseFloat(j.fixed)||0;if(f>0){st[i].p+=f;total+=f;}});
  const maxI=st.reduce((mx,_,i)=>st[i].p>(st[mx]?.p||0)?i:mx,0);
  const dk=document.body.getAttribute('data-theme')==='dark';
  let html=`<div class="stats-row"><div class="scard"><div class="slbl">×¡×”"×› ×”×›× ×¡×”</div><div class="sval g">â‚ª${Math.round(total).toLocaleString('he-IL')}</div></div></div>`;
  jobs.forEach((j,i)=>{
    const pct=total>0?Math.round(st[i].p/total*100):0;
    html+=`<div class="card" style="border-right:4px solid ${j.color}"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-size:15px;font-weight:800">${j.name}</div>${i===maxI&&total>0?`<span style="background:var(--gl);color:var(--g);padding:3px 8px;border-radius:20px;font-size:11px;font-weight:700">ğŸ† ××•×‘×™×œ</span>`:''}</div>
    <div style="display:flex;gap:20px;margin-bottom:10px">
      <div><div class="slbl">×©×¢×•×ª</div><div style="font-size:20px;font-weight:900;color:${j.color}">${st[i].h.toFixed(1)}</div></div>
      <div><div class="slbl">×”×›× ×¡×”</div><div style="font-size:20px;font-weight:900;color:var(--g)">â‚ª${Math.round(st[i].p).toLocaleString('he-IL')}</div></div>
      <div><div class="slbl">% ××¡×”"×›</div><div style="font-size:20px;font-weight:900;color:var(--t2)">${pct}%</div></div>
    </div>
    <div class="pbar-wrap"><div class="pbar-fill" style="width:${pct}%;background:${j.color}"></div></div></div>`;
  });
  html+=`<div class="card"><div class="csummary"><span>×”×©×•×•××” ×‘×™×Ÿ ××§×•××•×ª ×”×¢×‘×•×“×”</span></div><div class="cwrap"><canvas id="jCh"></canvas></div></div>`;
  cont.innerHTML=html;
  if(jCh)jCh.destroy();
  jCh=new Chart(document.getElementById('jCh'),{type:'bar',data:{labels:jobs.map(j=>j.name),datasets:[{data:st.map(x=>Math.round(x.p)),backgroundColor:jobs.map(j=>j.color),borderRadius:8,borderSkipped:false}]},options:cOpts(dk)});
}

function renderCmp(cont){
  const data=D.g(),groups={};
  Object.keys(data).forEach(k=>{const d=data[k],pr=cp(d.hours,d.rate,d.bonuses),mk=k.substring(0,7);groups[mk]=(groups[mk]||0)+pr.total;});
  const sorted=Object.keys(groups).sort();
  const lb=sorted.map(mk=>{const[y,m]=mk.split('-');return`${MN[parseInt(m)-1]} ${y.slice(2)}`;});
  const vals=sorted.map(mk=>Math.round(groups[mk]));
  const maxV=Math.max(...vals,0),maxI=vals.indexOf(maxV);
  const dk=document.body.getAttribute('data-theme')==='dark';
  cont.innerHTML=`<div class="card"><div class="csummary"><span>×”×’×‘×•×”: <strong>${lb[maxI]||'-'} â€” â‚ª${maxV.toLocaleString('he-IL')}</strong></span></div><div class="cwrap"><canvas id="cmpCh"></canvas></div></div>`;
  if(cmpCh)cmpCh.destroy();
  cmpCh=new Chart(document.getElementById('cmpCh'),{type:'bar',data:{labels:lb,datasets:[{data:vals,backgroundColor:vals.map((_,i)=>i===maxI?'#10B981':'#2563EB'),borderRadius:6,borderSkipped:false}]},options:cOpts(dk)});
}

function renderArc(cont){
  const data=D.g(),s=D.gs(),months={};
  Object.keys(data).forEach(k=>{const mk=k.substring(0,7),d=data[k],pr=cp(d.hours,d.rate,d.bonuses);if(!months[mk])months[mk]={h:0,p:0};months[mk].h+=d.hours;months[mk].p+=pr.total;});
  (s.jobs||[]).forEach(j=>{const f=parseFloat(j.fixed)||0;if(f>0)Object.keys(months).forEach(mk=>months[mk].p+=f);});
  const sorted=Object.keys(months).sort().reverse();
  if(!sorted.length){cont.innerHTML=`<div class="card"><div class="empty"><div class="empty-ico">ğŸ“…</div><div class="empty-ttl">××™×Ÿ × ×ª×•× ×™× ×¢×“×™×™×Ÿ</div></div></div>`;return;}
  let html='<div class="card">';
  sorted.forEach(mk=>{const[y,m]=mk.split('-');html+=`<div class="arc-row"><div><div class="arc-m">${MN[parseInt(m)-1]} ${y}</div></div><div class="arc-h">${months[mk].h.toFixed(1)} ×©'</div><div class="arc-p">â‚ª${Math.round(months[mk].p).toLocaleString('he-IL')}</div></div>`;});
  html+='</div>';cont.innerHTML=html;
}

// ---- COUPLE PAGE ----
function renderCouple(){
  const s=D.gs(),cont=document.getElementById('coupleContent');
  if(!s.pairCode){
    cont.innerHTML=`<div class="empty"><div class="empty-ico">ğŸ‘«</div><div class="empty-ttl">×œ× ××—×•×‘×¨×™× ×œ×–×•×’</div><div class="empty-sub">×—×‘×¨ ××ª ×¢×¦××š ×œ×¤×¨×˜× ×¨ ×›×“×™ ×œ×¨××•×ª ×”×›× ×¡×•×ª ××©×•×ª×¤×•×ª ×•×œ×¡× ×›×¨×Ÿ ×‘×–××Ÿ ×××ª</div><button class="btn btn-p" style="width:auto;padding:12px 28px;margin:20px auto 0;display:block" onclick="openPair()">ğŸ”— ×—×‘×¨ ×¤×¨×˜× ×¨</button></div>`;
    return;
  }
  const myD=D.g(),pd=D.gp(),dates=getDts('month');
  let myH=0,myP=0,pH=0,pP=0;
  dates.forEach(d=>{const k=fk(d);if(myD[k]){myH+=myD[k].hours||0;myP+=cp(myD[k].hours,myD[k].rate,myD[k].bonuses).total;}if(pd[k]){pH+=pd[k].hours||0;pP+=cp(pd[k].hours,pd[k].rate||50,pd[k].bonuses).total;}});
  const tot=myP+pP,myPct=tot>0?Math.round(myP/tot*100):50,pPct=100-myPct;
  const dk=document.body.getAttribute('data-theme')==='dark';
  cont.innerHTML=`
  <div class="couple-total"><div class="ct-lbl">ğŸ’° ×”×›× ×¡×” ××©×•×ª×¤×ª ×”×—×•×“×©</div><div class="ct-val">â‚ª${Math.round(tot).toLocaleString('he-IL')}</div><div class="ct-sub">${myH.toFixed(1)} + ${pH.toFixed(1)} ×©×¢×•×ª ×‘×™×—×“</div></div>
  <div class="ucard" style="background:${s.myColor}18;border-color:${s.myColor}">
    <div class="uc-top"><div class="uc-av" style="background:${s.myColor}">${s.myName.charAt(0)}</div><div><div class="uc-name" style="color:${s.myColor}">${s.myName}</div><div class="uc-h">${myH.toFixed(1)} ×©×¢×•×ª</div></div></div>
    <div class="uc-money" style="color:${s.myColor}">â‚ª${Math.round(myP).toLocaleString('he-IL')}</div>
    <div class="pbar-wrap" style="margin-top:10px"><div class="pbar-fill" style="width:${myPct}%;background:${s.myColor}"></div></div>
    <div style="font-size:11px;color:var(--t3);margin-top:4px">${myPct}% ××¡×”"×›</div>
  </div>
  <div class="ucard" style="background:${s.partnerColor}18;border-color:${s.partnerColor}">
    <div class="uc-top"><div class="uc-av" style="background:${s.partnerColor}">${s.partnerName.charAt(0)}</div><div><div class="uc-name" style="color:${s.partnerColor}">${s.partnerName}</div><div class="uc-h">${pH.toFixed(1)} ×©×¢×•×ª</div></div></div>
    <div class="uc-money" style="color:${s.partnerColor}">â‚ª${Math.round(pP).toLocaleString('he-IL')}</div>
    <div class="pbar-wrap" style="margin-top:10px"><div class="pbar-fill" style="width:${pPct}%;background:${s.partnerColor}"></div></div>
    <div style="font-size:11px;color:var(--t3);margin-top:4px">${pPct}% ××¡×”"×›</div>
  </div>
  <div class="card"><div class="csummary"><span>×”×©×•×•××” ×‘×™× ×™×›× ×”×—×•×“×©</span></div><div class="cwrap"><canvas id="cplCh"></canvas></div></div>
  <div class="card">
    <div style="font-size:12px;color:var(--t2);margin-bottom:10px">×§×•×“ ×–×™×•×•×’: <strong style="font-size:16px;letter-spacing:3px;color:var(--b8)">${s.pairCode}</strong></div>
    <button class="btn btn-g" onclick="manualSync()" style="margin-bottom:8px">ğŸ”„ ×¡× ×›×¨×Ÿ × ×ª×•× ×™ ×¤×¨×˜× ×¨</button>
    <button class="btn btn-o" onclick="openPair()" style="font-size:13px">âš™ï¸ ×”×’×“×¨×•×ª ×–×•×’</button>
  </div>`;
  if(cplCh)cplCh.destroy();
  cplCh=new Chart(document.getElementById('cplCh'),{type:'bar',data:{labels:[s.myName,s.partnerName],datasets:[{data:[Math.round(myP),Math.round(pP)],backgroundColor:[s.myColor,s.partnerColor],borderRadius:10,borderSkipped:false}]},options:cOpts(dk)});
}

// ---- PAIR MODAL ----
function openPair(){
  const s=D.gs(),cont=document.getElementById('pairCont');
  if(s.pairCode){
    cont.innerHTML=`
    <div class="pair-box"><div class="pair-lbl">×”×§×•×“ ×©×œ×™</div><div class="pair-val">${s.pairCode}</div>
    <div class="pair-acts">
      <button class="pair-btn" onclick="navigator.clipboard?.writeText('${s.pairCode}').then(()=>alert('×”×•×¢×ª×§!'))">ğŸ“‹ ×”×¢×ª×§</button>
      <button class="pair-btn" onclick="navigator.share?.({text:'×§×•×“ ×–×™×•×•×’: ${s.pairCode}'})">ğŸ“¤ ×©×ª×£</button>
    </div></div>
    <div id="qrB" style="display:flex;justify-content:center;padding:10px 0"></div>
    <div class="fg"><label class="fl">×”×©× ×©×œ×™</label><input type="text" class="fi" id="myNm" value="${s.myName}"></div>
    <div class="fg"><label class="fl">×”×¦×‘×¢ ×©×œ×™</label><div style="display:flex;gap:8px;flex-wrap:wrap">${JC.map(c=>`<div class="cdot${c===s.myColor?' sel':''}" style="background:${c}" onclick="setMC('${c}',this)"></div>`).join('')}</div></div>
    <div class="fg"><label class="fl">×©× ×”×¤×¨×˜× ×¨</label><input type="text" class="fi" id="pNm" value="${s.partnerName}"></div>
    <div class="fg"><label class="fl">×¦×‘×¢ ×”×¤×¨×˜× ×¨</label><div style="display:flex;gap:8px;flex-wrap:wrap">${JC.map(c=>`<div class="cdot${c===s.partnerColor?' sel':''}" style="background:${c}" onclick="setPC('${c}',this)"></div>`).join('')}</div></div>
    <button class="btn btn-p" onclick="savePairSet()">ğŸ’¾ ×©××•×¨</button>
    <button class="btn btn-d" onclick="unpair()" style="margin-top:8px">ğŸ”“ × ×ª×§ ××”×–×•×’</button>`;
    setTimeout(()=>{try{new QRCode(document.getElementById('qrB'),{text:s.pairCode,width:130,height:130,colorDark:'#1E3A8A',colorLight:'#fff'});}catch(e){}},100);
  } else {
    const nc=genCode();
    cont.innerHTML=`
    <p style="font-size:13px;color:var(--t2);margin-bottom:14px;line-height:1.6">×©×ª×£ ××ª ×”×§×•×“ ×©×œ×š ×¢× ×”×¤×¨×˜× ×¨, ××• ×”×–×Ÿ ××ª ×”×§×•×“ ×©×œ×• ×›×“×™ ×œ×”×ª×—×‘×¨. ×›×©×”×©× ×™×™× ××—×•×‘×¨×™× ×œ×’×•×’×œ, ×”× ×ª×•× ×™× ××¡×ª× ×›×¨× ×™× ××•×˜×•××˜×™×ª.</p>
    <div class="pair-box"><div class="pair-lbl">×”×§×•×“ ×©×œ×™</div><div class="pair-val">${nc}</div>
    <div class="pair-acts">
      <button class="pair-btn" onclick="navigator.clipboard?.writeText('${nc}').then(()=>alert('×”×•×¢×ª×§!'))">ğŸ“‹ ×”×¢×ª×§</button>
      <button class="pair-btn" onclick="navigator.share?.({text:'×§×•×“ ×–×™×•×•×’: ${nc}'})">ğŸ“¤ ×©×ª×£</button>
    </div></div>
    <div id="qrB2" style="display:flex;justify-content:center;padding:8px 0"></div>
    <div class="div"></div>
    <div class="fg"><label class="fl">×”×–×Ÿ ×§×•×“ ×©×œ ×”×¤×¨×˜× ×¨</label><input type="text" class="fi" id="pCode" placeholder="XXXXXX" maxlength="6" style="text-align:center;font-size:24px;letter-spacing:8px;font-weight:900"></div>
    <div class="fg"><label class="fl">×”×©× ×©×œ×™</label><input type="text" class="fi" id="myNmN" placeholder="×”×©× ×©×œ×š"></div>
    <div class="fg"><label class="fl">×©× ×”×¤×¨×˜× ×¨</label><input type="text" class="fi" id="pNmN" placeholder="×©× ×”×¤×¨×˜× ×¨"></div>
    <button class="btn btn-p" onclick="connPair('${nc}')">ğŸ”— ×”×ª×—×‘×¨ ×¢×›×©×™×•</button>`;
    setTimeout(()=>{try{new QRCode(document.getElementById('qrB2'),{text:nc,width:120,height:120,colorDark:'#1E3A8A',colorLight:'#fff'});}catch(e){}},100);
  }
  openM('mPair');
}
function genCode(){return Math.random().toString(36).substring(2,8).toUpperCase();}
function connPair(mc){
  const pc=document.getElementById('pCode')?.value.trim().toUpperCase();
  if(!pc){alert('×”×–×Ÿ ×§×•×“ ×¤×¨×˜× ×¨');return;}
  const s=D.gs();s.pairCode=mc;s.partnerCode=pc;
  s.myName=document.getElementById('myNmN')?.value||'×× ×™';
  s.partnerName=document.getElementById('pNmN')?.value||'×¤×¨×˜× ×¨';
  s.myUID=mc;D.ss(s);closeM('mPair');renderCouple();saveDr();
  alert('âœ… ×”×–×•×’ ×—×•×‘×¨! ×›×©×”×¤×¨×˜× ×¨ ×™×¡× ×›×¨×Ÿ ×œ×’×•×’×œ ×”× ×ª×•× ×™× ×©×œ×• ×™×•×¤×™×¢×• ××¦×œ×š ××•×˜×•××˜×™×ª.');
}
function savePairSet(){const s=D.gs();s.myName=document.getElementById('myNm')?.value||'×× ×™';s.partnerName=document.getElementById('pNm')?.value||'×¤×¨×˜× ×¨';D.ss(s);closeM('mPair');renderCouple();flash();vib();}
function setMC(c,el){el.closest('div').querySelectorAll('.cdot').forEach(d=>d.classList.remove('sel'));el.classList.add('sel');const s=D.gs();s.myColor=c;D.ss(s);}
function setPC(c,el){el.closest('div').querySelectorAll('.cdot').forEach(d=>d.classList.remove('sel'));el.classList.add('sel');const s=D.gs();s.partnerColor=c;D.ss(s);}
function unpair(){if(confirm('×œ× ×ª×§ ××”×–×•×’?')){const s=D.gs();s.pairCode=null;s.partnerCode=null;D.ss(s);localStorage.removeItem('pd');closeM('mPair');renderCouple();}}

// ---- SETTINGS ----
function renderSettings(){
  const s=D.gs();
  document.getElementById('togOT').checked=!!s.calcOvertime;
  document.getElementById('togMiss').checked=s.showMissing!==false;
  document.getElementById('drOff').style.display=aToken?'none':'block';
  document.getElementById('drOn').style.display=aToken?'block':'none';
  renderJobsCont();
}
function setSetting(k,v){const s=D.gs();s[k]=v;D.ss(s);if(k==='showMissing')renderCal();vib();}
function renderJobsCont(){
  const s=D.gs(),cont=document.getElementById('jobsCont');
  cont.innerHTML=(s.jobs||[]).map((j,i)=>`
  <div class="jcard" style="border-right:4px solid ${j.color}">
    ${(s.jobs||[]).length>1?`<button class="btn-del-j" onclick="delJob(${i})">Ã—</button>`:''}
    <div class="jcard-top"><div class="jcbadge" style="background:${j.color}"></div><input class="jname" value="${j.name}" onchange="updJ(${i},'name',this.value)"></div>
    <div class="jnums">
      <div class="fg" style="margin:0"><label class="fl">×ª×¢×¨×™×£ ×©×¢×ª×™ (â‚ª)</label><input type="number" class="fi" value="${j.rate}" onchange="updJ(${i},'rate',this.value)" placeholder="â‚ª/×©×¢×”"></div>
      <div class="fg" style="margin:0"><label class="fl">×¡×›×•× ×§×‘×•×¢ ×—×•×“×©×™ (â‚ª)</label><input type="number" class="fi" value="${j.fixed||0}" onchange="updJ(${i},'fixed',this.value)" placeholder="â‚ª/×—×•×“×©"></div>
    </div>
    <div class="fl" style="margin-bottom:6px">×¦×‘×¢</div>
    <div class="crow">${JC.map(c=>`<div class="cdot${c===j.color?' sel':''}" style="background:${c}" onclick="updJC(${i},'${c}',this)"></div>`).join('')}</div>
  </div>`).join('');
  document.getElementById('addJobBtn').style.display=(s.jobs||[]).length>=3?'none':'inline-flex';
}
function addJob(){const s=D.gs();if((s.jobs||[]).length>=3)return;s.jobs.push({name:`×¢×‘×•×“×” ${(s.jobs||[]).length+1}`,color:JC[(s.jobs||[]).length%JC.length],rate:50,fixed:0});D.ss(s);renderJobsCont();vib();}
function delJob(i){const s=D.gs();s.jobs.splice(i,1);D.ss(s);renderJobsCont();}
function updJ(i,f,v){const s=D.gs();s.jobs[i][f]=f==='name'?v:(parseFloat(v)||0);D.ss(s);}
function updJC(i,c,el){el.closest('.crow').querySelectorAll('.cdot').forEach(d=>d.classList.remove('sel'));el.classList.add('sel');updJ(i,'color',c);renderJobsCont();}

// ---- CLOCK ----
function initClock(){if(localStorage.getItem('cit')){tInt=setInterval(tickC,1000);tickC();const b=document.getElementById('clkBtn');b.textContent='â¹ ×¡×™×•× ××©××¨×ª';b.className='btn-clk on';document.getElementById('clkTime').classList.add('on');}}
function tickC(){const s=parseInt(localStorage.getItem('cit'));if(!s)return;const d=Math.floor((Date.now()-s)/1000);document.getElementById('clkTime').textContent=`${String(Math.floor(d/3600)).padStart(2,'0')}:${String(Math.floor(d%3600/60)).padStart(2,'0')}:${String(d%60).padStart(2,'0')}`;}
function handleClock(){
  vib();
  if(localStorage.getItem('cit')){
    clearInterval(tInt);const diff=(Date.now()-parseInt(localStorage.getItem('cit')))/3600000;
    localStorage.removeItem('cit');const b=document.getElementById('clkBtn');b.textContent='â–¶ ×”×ª×—×œ ××©××¨×ª';b.className='btn-clk';document.getElementById('clkTime').textContent='00:00:00';document.getElementById('clkTime').classList.remove('on');
    openDay(fk(new Date()));setTimeout(()=>{document.getElementById('dH').value=diff.toFixed(2);},100);
  } else {
    localStorage.setItem('cit',Date.now());tInt=setInterval(tickC,1000);const b=document.getElementById('clkBtn');b.textContent='â¹ ×¡×™×•× ××©××¨×ª';b.className='btn-clk on';document.getElementById('clkTime').classList.add('on');
  }
}

// ---- GOOGLE DRIVE ----
function initGD(){
  if(typeof google==='undefined'||!google.accounts){setTimeout(initGD,800);return;}
  try{
    tClient=google.accounts.oauth2.initTokenClient({client_id:CID,scope:SCOPES,callback:async resp=>{
      if(resp.error)return;aToken=resp.access_token;localStorage.setItem('syen','1');
      await fetchEmail();await loadDr();renderSettings();setSyncDot(true);
    }});
    document.getElementById('authBtn').onclick=()=>{vib();tClient.requestAccessToken();};
    if(localStorage.getItem('syen')==='1')setTimeout(()=>tClient.requestAccessToken({prompt:''}),1500);
  }catch(e){console.error(e);}
}
async function fetchEmail(){try{const r=await fetch('https://www.googleapis.com/oauth2/v3/userinfo',{headers:{Authorization:`Bearer ${aToken}`}});const i=await r.json();if(i.email)document.getElementById('drEmail').textContent=`××—×•×‘×¨: ${i.email}`;}catch(e){}}
async function saveDr(){
  if(!aToken)return;
  const s=D.gs();
  const fn=s.pairCode?`moneytime_pair_${s.pairCode}_${s.myUID||s.pairCode}.json`:'moneytime_db.json';
  const body=JSON.stringify({workData:D.g(),settings:s,timestamp:Date.now()});
  try{
    const list=await(await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${fn}'&spaces=appDataFolder`,{headers:{Authorization:`Bearer ${aToken}`}})).json();
    let fid=list.files?.[0]?.id;
    if(!fid){const cr=await(await fetch('https://www.googleapis.com/drive/v3/files',{method:'POST',headers:{Authorization:`Bearer ${aToken}`,'Content-Type':'application/json'},body:JSON.stringify({name:fn,parents:['appDataFolder']})})).json();fid=cr.id;}
    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fid}?uploadType=media`,{method:'PATCH',headers:{Authorization:`Bearer ${aToken}`,'Content-Type':'application/json'},body});
    setSyncDot(true);
  }catch(e){setSyncDot(false);}
}
async function loadDr(){
  if(!aToken)return;
  const s=D.gs();
  const fn=s.pairCode?`moneytime_pair_${s.pairCode}_${s.myUID||s.pairCode}.json`:'moneytime_db.json';
  try{
    const list=await(await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${fn}'&spaces=appDataFolder`,{headers:{Authorization:`Bearer ${aToken}`}})).json();
    if(list.files?.length>0){const cloud=await(await fetch(`https://www.googleapis.com/drive/v3/files/${list.files[0].id}?alt=media`,{headers:{Authorization:`Bearer ${aToken}`}})).json();const cTs=cloud.timestamp||0,lTs=parseInt(localStorage.getItem('wdts'))||0;if(cTs>lTs||lTs===0){if(cloud.workData)D.s(cloud.workData);}else{saveDr();}}
  }catch(e){}
  if(s.pairCode&&s.partnerCode){
    try{
      const q=encodeURIComponent(`name contains 'moneytime_pair_${s.partnerCode}'`);
      const pl=await(await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&spaces=appDataFolder`,{headers:{Authorization:`Bearer ${aToken}`}})).json();
      if(pl.files?.length>0){const pc=await(await fetch(`https://www.googleapis.com/drive/v3/files/${pl.files[0].id}?alt=media`,{headers:{Authorization:`Bearer ${aToken}`}})).json();if(pc.workData)D.sp(pc.workData);}
    }catch(e){}
  }
  renderCal();updRep();
}
async function manualSync(){
  vib();if(!aToken){alert('×œ× ××—×•×‘×¨ ×œ-Google Drive');return;}
  try{await loadDr();await saveDr();renderCal();if(document.getElementById('pg-couple').classList.contains('active'))renderCouple();alert('âœ… ×¡× ×›×¨×•×Ÿ ×”×•×©×œ×!');}
  catch(e){alert('×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ');}
}
function disconnDrive(){if(confirm('×œ× ×ª×§?')){aToken=null;localStorage.removeItem('syen');renderSettings();setSyncDot(false);}}
function setSyncDot(on){const d=document.getElementById('sdot');if(d)d.className='sdot'+(on?'':' off');}
window.addEventListener('online',()=>{if(aToken)saveDr();});

// ---- PDF ----
function tpdf(id){const el=document.getElementById(id);el.classList.toggle('on');el.textContent=el.classList.contains('on')?'âœ“':'';}
function genPDF(){
  try{
    const{jsPDF}=window.jspdf;const doc=new jsPDF({orientation:'p',unit:'mm',format:'a4'});
    const pr=document.getElementById('pdfPer').value,dates=getDts(pr,'pdfS','pdfE');
    const data=D.g(),s=D.gs(),pd=D.gp();
    const name=document.getElementById('pdfNm').value||s.myName;
    const iH=document.getElementById('po1').classList.contains('on'),iR=document.getElementById('po2').classList.contains('on');
    const iB=document.getElementById('po3').classList.contains('on'),iN=document.getElementById('po4').classList.contains('on');
    const iP=document.getElementById('po5').classList.contains('on')&&s.pairCode;
    const today=new Date().toLocaleDateString('he-IL');
    doc.setFillColor(30,58,138);doc.rect(0,0,210,28,'F');
    doc.setTextColor(255,255,255);doc.setFontSize(16);doc.setFont('helvetica','bold');
    doc.text('Work Hours Report',105,12,{align:'center'});
    doc.setFontSize(9);doc.setFont('helvetica','normal');
    doc.text(`${name}    ${today}`,105,21,{align:'center'});
    doc.setTextColor(0,0,0);
    let y=38;
    doc.setFillColor(240,244,255);doc.rect(10,y-5,190,8,'F');
    doc.setFontSize(9);doc.setFont('helvetica','bold');
    let hds=['Date'];if(iH)hds.push('Hours');if(iR)hds.push('Rate');hds.push('Total');if(iN)hds.push('Note');if(iP)hds.push('Partner');
    const cW=[36,20,22,26,52,28];let cx=14;
    hds.forEach((h,i)=>{doc.text(h,cx,y);cx+=cW[i]||22;});y+=8;
    let th=0,tp=0,ptp=0;doc.setFont('helvetica','normal');
    dates.forEach(d=>{
      const k=fk(d);if(!(data[k]?.hours>0))return;
      const pp2=cp(data[k].hours,data[k].rate,data[k].bonuses);th+=data[k].hours;tp+=pp2.total;
      if(y>272){doc.addPage();y=20;}
      if(Math.floor(y/7)%2===0){doc.setFillColor(248,250,255);doc.rect(10,y-5,190,7,'F');}
      cx=14;const row=[k];
      if(iH)row.push(data[k].hours.toFixed(1)+'h');if(iR)row.push(data[k].rate+'â‚ª');
      row.push(Math.round(pp2.total)+'â‚ª');if(iN)row.push((data[k].note||'').substring(0,18));
      if(iP){const pp3=pd[k];if(pp3?.hours>0){const pr3=cp(pp3.hours,pp3.rate||50,pp3.bonuses);ptp+=pr3.total;row.push(Math.round(pr3.total)+'â‚ª');}else row.push('-');}
      cx=14;row.forEach((r,i)=>{try{doc.text(String(r),cx,y);}catch(e){}cx+=cW[i]||22;});y+=7;
    });
    y+=6;doc.setFillColor(30,58,138);doc.rect(10,y-5,190,12,'F');
    doc.setTextColor(255,255,255);doc.setFont('helvetica','bold');doc.setFontSize(9);
    const sum=`Total: ${th.toFixed(1)}h | ${name}: â‚ª${Math.round(tp).toLocaleString()}`+(iP?` | Partner: â‚ª${Math.round(ptp).toLocaleString()} | Together: â‚ª${Math.round(tp+ptp).toLocaleString()}`:'');
    doc.text(sum,105,y+1,{align:'center'});
    doc.save(`hours_${name}_${today.replace(/\//g,'-')}.pdf`);
    closeM('mPDF');vib();
  }catch(e){alert('×©×’×™××” ×‘×™×¦×™×¨×ª PDF');console.error(e);}
}

// ---- BACKUP ----
function expCSV(){const d=D.g();let c='\uFEFF×ª××¨×™×š,×©×¢×•×ª,×ª×¢×¨×™×£,×¡×”"×›,×”×¢×¨×•×ª\n';Object.keys(d).sort().forEach(k=>{const r=d[k],pr=cp(r.hours,r.rate,r.bonuses);c+=`${k},${r.hours},${r.rate},${pr.total.toFixed(2)},${(r.note||'').replace(/,/g,' ')}\n`;});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([c],{type:'text/csv'}));a.download='×©×¢×•×ª.csv';a.click();}
function expJSON(){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify({workData:D.g(),settings:D.gs()})],{type:'application/json'}));a.download='×’×™×‘×•×™.json';a.click();}
function restoreData(e){const r=new FileReader();r.onload=ev=>{try{const p=JSON.parse(ev.target.result);if(p.workData)D.s(p.workData);if(p.settings)D.ss(p.settings);location.reload();}catch{alert('×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ');}};r.readAsText(e.target.files[0]);}
function execDel(){if(!confirm('×”×× ××ª×” ×‘×˜×•×—?'))return;const r=document.getElementById('delR').value;if(r==='all'){D.s({});location.reload();return;}let data=D.g();getDts(r,'delS','delE').forEach(d=>delete data[fk(d)]);D.s(data);closeM('mDel');renderCal();updRep();saveDr();vib();}

// ---- MODALS ----
function openM(id){document.getElementById(id).classList.add('active');}
function closeM(id){document.getElementById(id).classList.remove('active');}
document.querySelectorAll('.modal').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)closeM(m.id);});});

// ---- HELPERS ----
function vib(){try{navigator.vibrate?.(10);}catch(e){}}
function flash(){const el=document.getElementById('sf');el.className='sf show';setTimeout(()=>{el.className='sf bye';setTimeout(()=>el.className='sf',300);},900);}

// ---- KEYBOARD ----
document.addEventListener('keydown',e=>{
  if(e.key==='Escape')document.querySelectorAll('.modal.active').forEach(m=>m.classList.remove('active'));
  if(e.key==='Enter'&&document.getElementById('mDay').classList.contains('active'))saveDay();
});

// ---- PWA ----
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();dProm=e;document.getElementById('instBanner').classList.add('show');});
document.getElementById('instBtn').addEventListener('click',async()=>{if(dProm){dProm.prompt();const{outcome}=await dProm.userChoice;if(outcome==='accepted')document.getElementById('instBanner').classList.remove('show');dProm=null;}});
window.addEventListener('appinstalled',()=>document.getElementById('instBanner').classList.remove('show'));
if('serviceWorker' in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));

// ---- INIT ----
document.addEventListener('DOMContentLoaded',()=>{
  const s=D.gs();
  if(s.theme==='dark')toggleTheme(true);
  if(!s.myUID){s.myUID=Math.random().toString(36).substring(2,10);D.ss(s);}
  initClock();renderCal();setSyncDot(false);initGD();renderSettings();
});
</script>
</body>
</html>
